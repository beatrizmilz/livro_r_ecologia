---
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE
)
```

# Introdu√ß√£o √† An√°lises Multidimensionais

Em geral, an√°lises multivariadas t√™m tr√™s principais utilidades: reduzir a dimensionalidade dos dados e encontrar a principal dire√ß√£o de varia√ß√£o dos dados, testar rela√ß√µes entre matrizes, ou ainda encontrar diferen√ßas entre grupos. Apesar dessas an√°lises tamb√©m serem utilizadas como an√°lises explorat√≥rias e para descrever padr√µes em estudos ecol√≥gicos, a necessidade de se ter hip√≥teses, ou ao menos expectativas a priori, n√£o pode ser ignorada. Antes de entrar de cabe√ßa nas an√°lises multivariadas tamb√©m, sugerimos fortemente o estudo de m√©todos de amostragem e como fazer boas perguntas.

An√°lises multivariadas podem ser divididas, grosseiramente, em dois tipos: agrupamento e ordena√ß√£o. An√°lises de agrupamento em geral tentam agrupar objetos (observa√ß√µes) ou descritores em grupos de maneira que objetos do mesmo grupo sejam mais semelhantes entre si do que objetos de outros grupos (Legendre & Legendre, 2012). Por outro lado, a an√°lise de ordena√ß√£o √© uma opera√ß√£o pela qual os objetos (ou descritores) s√£o posicionados num espa√ßo que cont√©m menos dimens√µes que o conjunto de dados original; a posi√ß√£o dos objetos ou descritores em rela√ß√£o aos outros tamb√©m podem ser usadas para agrup√°-los.

Vamos come√ßar com an√°lises de agrupamento. Aqui vamos exemplificar dois m√©todos: uma t√©cnica de agrupamento hierarquica (dendrograma) e outra n√£o-hierarquica (k-means).

## Coeficientes de associa√ß√£o

Assim chamados genericamente, os coeficientes de associa√ß√£o medem o qu√£o parecidos objetos ou descritores s√£o entre si. Quando analisamos a rela√ß√£o entre objetos fazemos uma an√°lise no modo Q, ao passo que o modo R √© quando analisamos a rela√ß√£o entre descritores. Coeficientes de associa√ß√£o do modo Q s√£o medidas de (dis)similaridade ou dist√¢ncia, enquanto para o modo R utilizamos covari√¢ncia ou correla√ß√£o. Como j√° tratamos neste livro sobre covari√¢ncia e correla√ß√£o, neste t√≥pico vamos falar sobre √≠ndices de dist√¢ncia e similaridade. Mas qual a defini√ß√£o destas duas quantitades?

> Similaridade s√£o m√°ximas (*S=1*) quando dois objetos s√£o id√™nticos
>
> Dist√¢ncias s√£o o contr√°rio da similaridade (*D=1-S*) e n√£o t√™m limites superiores (dependem da unidade de medida)

Existem ao menos 26 √≠ndices de similaridade que podem ser agrupados de acordo com o tipo de dado (qualitativos ou quantitativos), a maneira com que lidam com duplos zeros (sim√©tricos ou assim√©tricos). Do seu lado, as dist√¢ncias s√≥ se aplicam a dados quantitativos e t√™m como caracter√≠sticas serem m√©tricas, semi-m√©tricas ou n√£o-m√©tricas. Vejamos agora os principais √≠ndices de similaridade e dist√¢ncia de cada tipo.

### Dist√¢ncias m√©tricas

O principal coeficiente de dist√¢ncia usado em ecologia √© a dist√¢ncia euclidiana. Al√©m disso temos ainda Canberra, Mahalanobis (calcula a dist√¢ncia entre dois pontos num espa√ßo n√£o ortogonal, levando em considera√ß√£o a covari√¢ncia entre descritores), Manhattan, Chord (elimina diferen√ßas entre abund√¢ncia total de esp√©cies), ùúí2 (d√° peso maior para esp√©cies raras), Hellinger (n√£o d√° peso para esp√©cies raras). Essas dist√¢ncias s√£o recomendada nos casos em que as vari√°veis de estudo forem cont√≠nuas, como por exemplo **vari√°veis morfom√©tricas ou descritores ambientais**.

Uma caracter√≠stica comum de conjuntos de dados ecol√≥gicos s√£o os v√°rios zeros encontrados em matrizes de composi√ß√£o. Eles surgem porque n√£o encontramos nenhum indiv√≠duo de uma determinada esp√©cie num local, seja porque aquele local n√£o tem as condi√ß√µes ambientais adequadas a ela, falha na detectabilidade, ou din√¢micas demogr√°ficas estoc√°sticas de coloniza√ß√£o-extin√ß√£o. Logo, quando dois locais compartilham aus√™ncia de esp√©cies, n√£o √© poss√≠vel atribuir uma √∫nica raz√£o da dupla aus√™ncia. Como essas medidas de dist√¢ncia apresentadas acima assumem que os dados s√£o quantitativos e n√£o de contagem, elas n√£o s√£o adequadas para lidar com dados de abund√¢ncia ou incid√™ncia de esp√©cies, porque atribuem um grau de parec√™n√ßa a pares de locais que compartilham zeros [@numerica2012]. Por esse motivo precisamos de coeficientes que desconsiderem os duplos zeros. Eles s√£o chamados de *assim√©tricos.*

### Coeficientes assim√©tricos bin√°rios para objetos

Esses coeficientes (ou √≠ndices) s√£o apropriados para dados de incid√™ncia de esp√©cies (presen√ßa-aus√™ncia) e desconsideram as duplas aus√™ncias. Os √≠ndices deste tipo mais comuns utilizados em ecologia s√£o S√∏rensen, Jaccard, e Ochiai.

$$
\beta j= a/a+b+c
$$

, onde *a* = n√∫mero de esp√©cies compartilhadas, *b* = n√∫mero de esp√©cies exclusivas da comunidade 1, *c* = n√∫mero de esp√©cies exclusivas da comunidade 2. A diferen√ßa entre Jaccard e S√∏rensen √© o S√∏rensen d√° peso dobrado para duplas presen√ßas. Por conta dessas caracter√≠sticas estes √≠ndices s√£o adequados para quantificar diversidade beta [@legendre2013] [@anderson2010]. Esses √≠ndices variam entre 0 (nenhuma esp√©cie √© compartilhada entre o par de locais) a 1 (todas as esp√©cies s√£o compartilhadas entre o par de locais).

### Coeficientes bin√°rios para descritores (R mode)

Se o objetivo for calcular a similaridade entre descritores bin√°rios (e.g., presen√ßa ou aus√™ncia de caracter√≠sticas ambientais) de pares de locais, geralmente o coeficiente recomendado √© o de Sokal & Michener. Este √≠ndice est√° implementado em `ade4::dist.binary`.

### Coeficientes quantitativos para objetos

Estes s√£o os coeficientes utilizados para dados de contagem (e.g., abund√¢ncia), quantitativos (e.g., frequ√™ncia, biomassa, porcentagem cobertura). Diferentemente das dist√¢ncias, estes coeficientes s√£o assim√©tricos, ou seja, n√£o consideram duplas aus√™ncias, e portanto s√£o adequados para analisar dados de composi√ß√£o de esp√©cies. Al√©m disso, uma outra caracter√≠stica deles √© serem semi-m√©tricos. Os √≠ndices mais comuns deste tipo s√£o Bray-Curtis (percentage difference), Chord, log-Chord, Hellinger, chi-quadrado, e Morisita-Horn.

Todos os √≠ndices discutidos at√© aqui est√£o implementados nas fun√ß√µes `ade4::dist.ktab`, `adespatial::dist.ldc`, e `vegan::vegdist`.

### Coeficientes para descritores (R mode) que que inclui mistura de tipos de dados

√â comum em an√°lises de diversidade funcional que tenhamos um conjunto de atributos (traits) de esp√©cies que s√£o formados por v√°rios tipos de dados: quantitativos (e.g., tamanho de corpo), bin√°rios (presen√ßa aus√™ncia de uma dada caracter√≠stica), fuzzy (um atributo multiestado descrito codificado em v√°rias colunas com porcentagem), ordinais, e circulares (e.g., distribui√ß√£o de uma fenofase ao longo de um ano). O √≠ndice que lida com todos esses dados √© o Gower. A vers√£o extendida do √≠ndice de Gower pode ser encontrada na fun√ß√£o `ade4::dist.ktab.`

O cap√≠tulo 7 de [@numerica2012] fornece uma chave dicot√¥mica para escolha do √≠ndice mais adequado.

## Padroniza√ß√µes e transforma√ß√µes

√â comum coletarmos m√∫ltiplas vari√°veis ambientais cujas unidades sejam diferentes. Por exemplo, temperatura (¬∫C), dist√¢ncia da margem (m), √°rea (m^2^). Para diminuir a taxa de Erro Tipo I das an√°lises √© recomendado que ***padronizemos*** os dados utilizando distribui√ß√£o *Z*, assim todas as vari√°veis passam a ter m√©dia 0 e desvio padr√£o 1. Essa padroniza√ß√£o pode ser implementada na fun√ß√£o `vegan::decostand`.

Um outro problema comum de matrizes de dados de composi√ß√£o de esp√©cies √© o alto n√∫mero de zeros, enquanto outras esp√©cies podem ter altas abund√¢ncias. Isso gera problemas em ordena√ß√µes. Para diminuir esta discrep√¢ncia podemos ***transformar*** os dados, por exemplo, utilizando a dist√¢ncia de Hellinger ou Chord. Isso pode ser feito na fun√ß√£o `vegan::decostand`.

# An√°lise de agrupamento hierarquico

## Backgorund da an√°lise

O objetivo da an√°lise de agrupamento √© agrupar objetos admitindo que haja um grau de similaridade entre eles. Esta an√°lise pode ser utilizada ainda para classificar uma popula√ß√£o em grupos homog√™neos de acordo com uma caracter√≠stica de interesse. A grosso modo, uma an√°lise de agrupamento tenta resumir uma grande quantidade de dados e apresent√°la de maneira f√°cil de visualizar e entender (em geral, na forma de um dendrograma). No entanto, os resultados da an√°lise podem n√£o refletir necessariamente toda a informa√ß√£o originalmente contida na matriz de dados. Para avaliar o qu√£o bem uma an√°lise de agrupamento representa os dados originais existe uma m√©trica --- o coeficiente de correla√ß√£o cofen√©tico --- o qual discutiremos em detalhes mais adiante.

Antes de considerar algum m√©todo de agrupamento, pense porque voc√™ esperaria que houvesse uma descontinuidade nos dados; ou ainda, considere se existe algum ganho pr√°tico em dividir uma nuvem de objetos cont√≠nuos em grupos. O padr√£o apresentado pelo dendograma depende do protocolo utilizado (m√©todo de agrupamento e √≠ndice de dissimilaridade); os grupos formados dependem do n√≠vel de corte escolhido.

### Explica√ß√£o da an√°lise

A matriz deve conter os objetos a serem agrupados (e.g., esp√©cies) nas linhas e as vari√°veis (e.g., locais de coleta ou medidas morfol√≥gicas) nas colunas. A escolha do m√©todo de agrupamento √© cr√≠tico para a escolha de um coeficiente de associa√ß√£o. √â importante compreender as propriedades dos m√©todos de agrupamento para interpretar corretamente a estrutura ecol√≥gica que eles evidenciam [@numerica2012]. De acordo com a classifica√ß√£o de Sneath & Sokal (1973) existem cinco tipos de m√©todos: 1) sequÃàenciais ou simult√¢neos; 2) aglomerativo ou divisivo ;3) monot√©ticos ou polit√©ticos; 4) hier√°rquico ou n√£o hier√°rquicos e 5) probabil√≠stico.

M√©todos hier√°rquicos podem ser divididos naqueles que consideram o centr√≥ide ou a m√©dia aritm√©tica entre os grupos. O principal m√©todo hier√°rquico que utiliza a m√©dia aritm√©tica √© o UPGMA (Agrupamento pelas m√©dias aritm√©ticas n√£o ponderadas), e o principal m√©todo que utiliza centr√≥ides √© a Dist√¢ncia m√≠nima de Ward.

O UPGMA funciona da seguinte forma: a maior similaridade (ou menor dist√¢ncia) identifica os pr√≥ximos agrupamentos a serem formados. Ap√≥s esse evento, o m√©todo calcula a m√©dia aritm√©tica das similaridades ou dist√¢ncias entre um objeto e cada um dos membros do grupo ou, no caso de um grupo previamente formado, entre todos os membros dos dois grupos. Todos os objetos recebem pesos iguais no c√°lculo.

O m√©todo de Ward √© baseado no crit√©rio de quadrados m√≠nimos (OLS), o mesmo utilizado para ajustar um modelo linear. O objetivo √© definir os grupos de maneira que a soma de quadrados (i.e. similar ao erro quadrado da ANOVA) dentro dos grupos seja minimizada [@borcard2018].

No entanto, para interpretar os resultados precisamos antes definir um n√≠vel de corte, que vai nos dizer quantos grupos existem. H√° v√°rios m√©todos para definir grupos, desde os heur√≠sticos aos que utilizam bootstrap. Se quisermos interpretar este dendrograma, podemos por exemplo estabelecer um n√≠vel de corte de 50% de dist√¢ncia (ou seja, grupos cujos objetos tenham ao menos 50% de similaridade entre si).

**Checklist**

-   Verifique se n√£o h√° espa√ßo nos nomes das colunas e linhas
-   Se os dados forem de abund√¢ncia, recomenda-se realizar a transforma√ß√£o de Hellinger [@legendre2001].
-   Se a matriz original contiver muitos valores discrepantes (e.g., uma esp√©cie muito mais ou muito menos abundante que outras) √© necess√°rio transformar os dados usando `log1p`.
-   Se as vari√°veis forem medidas tomadas em diferentes escalas (metros, graus celcius etc), √© necess√°rio padronizar cada vari√°vel para ter a m√©dia 0 e desvio padr√£o 1. Isso pode ser feito utulizando a fun√ß√£o `decostand` do pacote `vegan`.

## Exemplo 1:

Neste exemplo vamos utilizar um conjunto de dados que cont√©m larvas de esp√©cies de anf√≠bios anuros coletados em 14 po√ßas que diferiam em termos de cobertura de dossel.

**Pergunta:**

> Existem grupos de esp√©cies de anf√≠bios anuros com padr√µes de ocorr√™ncia similar ao longo de po√ßas?

**Predi√ß√µes**

> Iremos encontrar ao menos dois grupos de esp√©cies: aquelas que ocorrem em po√ßas dentro de floresta vs. aquelas que ocorrem em po√ßas de √°reas abertas.

**Vari√°veis**

-   Vari√°veis preditoras

-   A nossa matriz de dados cont√©m a abund√¢ncia das esp√©cies nas linhas e locais (po√ßas) nas colunas.

### An√°lise

Para come√ßar, vamos primeiro importar os dados e depois calcular a matriz de dist√¢ncia que seja adequada para o tipo de dado que temos (abund√¢ncia de esp√©cies - dados de contagem)

```{r message=FALSE, warning=FALSE}
library(vegan) 
library(tidyverse)

sp_compos <- read.table("bocaina.txt", h=TRUE)
head(sp_compos)
#produz uma matriz de similaridade com o coeficiente de Morisita-Horn
distBocaina <- vegdist(sp_compos, method="horn")
#produz um agrupamento com a fun√ß√£o hclust e o m√©todo UPGMA
dendro <- hclust(distBocaina, method="average")
```

Visualizar os resultados

```{r}
plot(dendro)
```

#### Assessando a qualidade do dendrograma

Precisamos verificar que o agrupamento reduziu a dimensionalidade da matiz de forma eficiente, de maneira a n√£o distorcer a informa√ß√£o. Fazemos isso calculando o **Coeficiente de correla√ß√£o cofen√©tica (CCC)**

```{r}
cofresult <- cophenetic(dendro)
cor(cofresult, distBocaina)
```

Um CCC \> .7 indica uma boa representa√ß√£o. Portanto, o nosso resultado de `r cor(cofresult, distBocaina)` √© bastante alto, garantindo que o dendrograma √© adequado.

```{r}
plot(dendro)
k = 4
n = ncol(sp_compos)
MidPoint = (dendro$height[n-k] + dendro$height[n-k+1]) / 2
abline(h = MidPoint, lty=2)
```

Nesse caso teremos a forma√ß√£o de cinco grupos, representados pelos n√≥s que est√£o abaixo da linha de corte. Portanto, o resultado n√£o suporta a nossa hip√≥tese *a priori* que predizia a forma√ß√£o de apenas dois grupos de esp√©cies.

## Exemplo 2:

No exemplo anterior vimos que √© dif√≠cil interpretar os grupos baseado num n√≠vel de corte. A seguir, vamos utilizar o pacote `pvclust` que calcula automaticamente o n√≠vel de corte de similaridade baseado no Bootstrap de cada n√≥. Uma desvantagem deste m√©todo √© que ele somente aceita √≠ndices de similaridade da fun√ß√£o `dist` que possui apenas a dist√¢ncia Euclidiana, Manhattan e Canberra. Uma maneira de contornarmos essa limita√ß√£o √© utilizar transforma√ß√µes dos dados dispon√≠veis na fun√ß√£o `disttransform` no pacote `BiodiversityR` ou o `decostand` do pacote `vegan`. Tamb√©m √© poss√≠vel utilizar a transforma√ß√£o de Box-Cox para dados multivariados, dispon√≠vel no material suplementar de [@legendre2018] [aqui](http://www.ecography.org/appendix/ecog-03498)

### An√°lise

Vamos utilizar o mesmo conjunto de dados acima pra responder √† mesma pergunta.

```{r message=FALSE, warning=FALSE}
library(pvclust)
library(BiodiversityR)
```

Aqui vamos utilizar a dist√¢ncia de Chord para calcular a matriz de dist√¢ncia. Se transformarmos uma matriz usando a transforma√ß√£o Chord e depois calcularmos a dist√¢ncia Euclidiana, isso equivale √† calcular diretamente a dist√¢ncia de Chord:

```{r}
bocaina <- read.table("bocaina.txt", h=T)
bocaina_transf <- disttransform(bocaina, "chord")
analise <- pvclust(bocaina_transf, method.hclust="average", method.dist="euclidean") 
plot(analise, hang=-1)
pvrect(analise)
```

√â poss√≠vel notar que existe um √∫nico grupo com BS \> 95%. Agora vamos tentar usar a dist√¢ncia de Hellinger:

```{r}
bocaina_transf2 <- disttransform(bocaina, "hellinger")
analise2 <- pvclust(bocaina_transf2, method.hclust="average", method.dist="euclidean") 
plot(analise2, hang=-1)
pvrect(analise2)
```

### Interpreta√ß√£o dos resultados

Notem que se mudarmos o coeficiente de associa√ß√£o, o resultado tamb√©m muda. Agora temos 1 grupo a mais, composto por *Dendropsophus minutus* e *Scinax duartei* que n√£o apareciam antes. Isso se deve ao fato de que a dist√¢ncia de Hellinger d√° menos peso para esp√©cies raras do que a Chord.

Neste sentido, os dados n√£o suportam a nossa hip√≥tese inicial da forma√ß√£o de dois grupos, independentemente do coeficiente de associa√ß√£o utilizado.

# K-means e agrupamentos n√£o-hierarquicos

## Backgorund da an√°lise

K-means √© um tipo de agrupamento n√£o hierarquico porque n√£o busca obter grupos menores que por sua vez pertencem a grupos maiores. Resumidamente, podemos calcular o K-means apartir de uma matriz quadrada ou de dist√¢ncia. Essa t√©cnica procura particionar os objetos em *k* grupos de maneira a minimizar a soma de quadrados entre grupos e maximiz√°-la dentro dos grupos. Um crit√©rio similar ao de uma ANOVA.

## Exemplo 1

Para este exemplo iremos utilizar um conjunto de dados dispon√≠vel no pacote `ade4` que cont√©m dados de 27 esp√©cies de peixes coletados em 30 pontos ao longo do Rio Doubs, na fronteira entre a Fran√ßa e Sui√ßa.

**Pergunta:**

> Qual √© o n√∫mero de grupos que melhor sumariza o padr√£o de ocorr√™ncia de esp√©cies de peixes ao longo de um riacho?

**Predi√ß√µes**

> -   O agrupamento ideal para explicar a vari√¢ncia no padr√£o de ocorr√™ncia de esp√©cies √© 4.

**Vari√°veis**

-   Vari√°veis resposta

### Explica√ß√£o da an√°lise

Um diferencial do K-means em rela√ß√£o aos agrupamentos hierarquicos (=clusters) √© que o usu√°rio pode escolher antecipadamente o n√∫mero de grupos que quer formar.

**Checklist**

-   Vamos normalizar os dados de abund√¢ncia antes de entrar na an√°lise propriamente, j√° que existem muitos zeros na matriz.

### An√°lise

```{r message=FALSE, warning=FALSE}
library(ade4)
data(doubs)
head(doubs$fish)
spe <- doubs$fish[-8,]# retiro a linha 8, pois n√£o h√° dados
spe.norm <- decostand(spe, "normalize") # fun√ß√£o do pacote vegan, ela faz v√°rias padroniza√ß√µes, aqui ele normaliza  
```

O argumento `centers` na fun√ß√£o abaixo indica o n√∫mero de grupos que se quer formar. Neste exemplo estamos utilizando `centers=4`.

```{r}
spe.kmeans <- kmeans(spe.norm, centers=4, nstart=100)
spe.kmeans
```

O objeto que fornece o resultado cont√©m: 1) o tamanho (n√∫mero de objetos) em cada um dos 4 grupos; 2) o centroid de cada grupo e o pertencimento de cada esp√©cie a cada grupo; e 3) o quando da Soma de Quadrados dos dados √© explicada por esta conforma√ß√£o de grupos.

No entanto, n√£o √© poss√≠vel saber a priori qual o n√∫mero *ideal* de grupos. Para descobrir isso repetimos o k-means com uma s√©rie de valores de **K**. Isso pode ser feito na fun√ß√£o `cascadeKM`.

```{r}
spe.KM.cascade <- cascadeKM(spe.norm, inf.gr=2, sup.gr=10, iter=100, criterion="ssi") 
```

Tanto **calinski** quando **ssi** s√£o bons crit√©rios para encontrar o n√∫mero ideal de grupos. Quanto maior o valor de **ssi** melhor (veja `?cascadeKM` mais detalhes).

```{r}
# summary
spe.KM.cascade$results
```

SSE: crit√©rio utilizado pelo algor√≠timo para achar o agrupamento √≥timo dos objetos.

```{r}
plot(spe.KM.cascade, sortg=TRUE)
```

### Interpreta√ß√£o dos resultados

Diferentemente da nossa predi√ß√£o inicial, o resultado da an√°lise mostra que o n√∫mero ideal de grupos para explicar a vari√¢ncia no padr√£o de ocorr√™ncia de esp√©cies √© 3. Notem que o SSI m√°ximo √© alcan√ßado neste n√∫mero de grupos `r spe.KM.cascade$results[2,2]` (tamb√©m indicado pela bola vermelha no plot).

# Esp√©cies indicadoras

## Backgorund da an√°lise

Uma pergunta normalmente feita por ec√≥logos √©: qual esp√©cie pode ser indicadora de uma determinada condi√ß√£o ambiental?

O √≠ndice IndVal mede dois aspectos das esp√©cies: Especificidade e fidelidade. Uma alta fidelidade significa que esp√©cies ocorrem em todos os locais do grupo e uma alta especificidade significa que as esp√©cies ocorrem somente naquele grupo. Uma boa esp√©cie indicadora √© aquela na qual todos os indiv√≠duos ocorrem em todas a amostras referentes a um grupo espec√≠fico. A Especificidade √© dada pela divis√£o da abundancia m√©dia da esp√©cie no grupo pela somat√≥ria das abundancias m√©dias dos grupos. Fidelidade √© igual ao n√∫mero de lugares no grupo onde a esp√©cie est√° presente dividido pelo n√∫mero total de lugares do grupo (Dufr√™ne & Legendre, 1997).

Esp√©cies raras podem receber o mesmo valor de IndVal das esp√©cies indicadoras e s√£o chamadas de indicadoras assim√©tricas, i.e., contribuem com a especificidade do habitat mas n√£o servem para predizer grupos. Ao contr√°rio, as esp√©cies indicadoras s√£o verdadeiros indicadores sim√©tricos e podem ser usadas para predizer grupos.

## Exemplo 1:

**Pergunta:**

> Qual esp√©cie de anf√≠bio anuro na fase larval pode ser indicadora da fitofisionomia onde √© encontrada?

**Predi√ß√µes**

> -   1: Esp√©cies terrestres ser√£o indicadoras de √°rea aberta, enquanto esp√©cies arbor√≠colas ser√£o indicadoras de √°reas florestais.

**Vari√°veis**

-   Vari√°veis resposta

-   Mesma matriz j√° utilizada contendo a abund√¢ncia de girinos ao longo de po√ßas na Serra da Bocaina.

### Explica√ß√£o da an√°lise

A an√°lise procede da seguinte forma:

-   Uma matriz de dist√¢ncia √© constru√≠da e as unidades amostrais s√£o classificadas com alguma an√°lise de agrupamento, hier√°rquico ou n√£o;

-   A vari√°vel ambiental para a qual se deseja classificar os grupos √© inserida;

-   As esp√©cies indicadoreas de cada grupo s√£o formadas atrav√©s do c√°lculo da especificidade e fidelidade, obtendo-se o valor de IndVal para cada esp√©cie;

-   Por fim, o conjunto de dados originais √© comparado para ver se an√°lise faz sentido.

O c√°lculo da signific√¢ncia do √≠ndice de IndVal √© feito por aleatoriza√ß√£o de Monte Carlo. Assim, o valor do √≠ndice √© aleatorizado 999 vezes (ou o n√∫mero de vezes que voc√™ optar) dentro dos tratamentos e o valor de *P* √© dado pelo n√∫mero de vezes em que o √≠ndice observado foi igual ou maior que os valores aleatorizados.

### An√°lise

Para este exemplo vamos utilizado o mesmo conjunto de dados utilizado acima com abund√¢ncia de 16 esp√©cies de girinos coletados em 14 po√ßas com diferentes graus de cobertura de dossel na Serra da Bocaina.

O IndVal est√° dispon√≠vel tanto no pacote `indicspecies` quando no `labdsv`. Para este exemplo iremos usar o labdsv.

```{r}
library(labdsv)
```

Primeiro vamos agrupar as unidades amostrais (po√ßas) que informa os grupos de fitofisionomias onde as po√ßas se localizam e para os quais deseja-se encontrar esp√©cies indicadoras:

```{r}
fitofis <- c(rep(1,4), rep(2,4), rep(3,4), rep(4,4), rep(5,4))
```

```{r}
resultado <- indval(bocaina, fitofis)
summary(resultado)#s√≥ exibe o resultado para as esp√©cies indicadoras
```

Para apresentar uma tabela dos resultados para todas as esp√©cies temos de processar os dados:

```{r}
resultado$maxcls
resultado$indcls
resultado$pval
tab.resultado=cbind(resultado$maxcls,resultado$indcls,resultado$pval)
colnames(tab.resultado)<-c("maxgrp", "ind. value","P")
tab.resultado
```

### Interpreta√ß√£o dos resultados

No resultado podemos ver que temos duas esp√©cies indicadoras da fitofisionimia 1: *Rhinella icterica* (Rict) e *Scinax duartei* (Sduar). Nenhuma esp√©cie foi indicadora dos outros grupos neste exemplo.

### Para se aprofundar

-   [Agrupamento de esp√©cies e locais baseado em modelos](https://www.sciencedirect.com/science/article/pii/S0304380010006393?casa_token=0YLFbVbGj1IAAAAA:RFcrLHBDdt-NY5gpxCEAqlc8LMG0ayzChpMvaOFQkE10ftg2Us6PafgMQCSmCZZ21eb430e_lWo)

-   [Numerical Ecology with R](http://adn.biol.umontreal.ca/~numericalecology/numecolR/)

-   [James & McCulloch (1990)](https://www.annualreviews.org/doi/pdf/10.1146/annurev.es.21.110190.001021)

-   [Legendre & Legendre (2012)](https://www.sciencedirect.com/bookseries/developments-in-environmental-modelling/vol/24)

# An√°lises de Ordena√ß√£o

O ordena√ß√£o represente um conjunto de t√©cnicas multivariadas que busca organizar objetos (e.g., localidades, indiv√≠duos, esp√©cies) em alguma ordem. Ao buscar esta *ordem,* as t√©cnicas de ordena√ß√£o possuem tr√™s principais utilidades: **(1)** reduzir a dimensionalidade e revelar padr√µes, **(2)** separar vari√°veis mais e menos importantes em combina√ß√µes complexas, e **(3)** separar rela√ß√µes mais e menos fortes ao comparar vari√°veis preditoras e dependentes. Em geral, os m√©todos s√£o divid√≠dos em ordena√ß√µes irrestritas (ou an√°lise de gradiente indireto) e restritas (ou an√°lise de gradiente direto). As ordena√ß√µes irrestritas organizam os objetos (e.g., esp√©cies) de acordo com sua estrutura de covari√¢ncia (ou correla√ß√£o), o que demonstra que a proximidade (ou dist√¢ncia) dentro do espa√ßo multidimensional representa semelhan√ßa (ou diferen√ßa) dos objetos. Por outro lado, as ordena√ß√µes restritras posiciona os objetos (e.g., esp√©cies) de acordo com sua rela√ß√£o linear com outras vari√°veis coletadas nas mesmas unidades amostraits (e.g., temperatura e precipita√ß√£o). Ao passo que as ordena√ß√µes irrestritas dependem somente de uma matriz (e.g., esp√©cies por localidades), as ordena√ß√µes restritas utilizam no m√≠nimo duas matrizes (e.g., esp√©cies por localidades e vari√°veis clim√°ticas por localidade). Desse modo, fica claro por esta diferen√ßa entre os dados utilizados que as an√°lises irrestritas s√£o mais explorat√≥rias, enquanto an√°lises restritas s√£o ideias para testar hip√≥teses com dados multidimensionais. A tabela a seguir apresenta as principais an√°lises utilizadas em ecologia.

+--------------------------+---------------------------------------------------------------------------------------------------------------------+--------------------+
| M√©todo                   | Tipo de vari√°vel                                                                                                    | Fun√ß√£o R           |
+==========================+=====================================================================================================================+====================+
| **Ordena√ß√£o irrestrita** |                                                                                                                     |                    |
+--------------------------+---------------------------------------------------------------------------------------------------------------------+--------------------+
| PCA                      | Vari√°veis cont√≠nuas (dist√¢ncia euclideana)                                                                          | PCA, rda, dudi.pca |
+--------------------------+---------------------------------------------------------------------------------------------------------------------+--------------------+
| PCoA                     | Aceita qualquer tipo de vari√°vel, mas depende da escolha apropriada de uma medida de dist√¢ncia                      | pcoa, dudi.pco     |
+--------------------------+---------------------------------------------------------------------------------------------------------------------+--------------------+
| nMDS                     | Aceita qualquer tipo de vari√°vel, mas depende da escolha apropriada de uma medida de dist√¢ncia                      | metaMDS, nmds      |
+--------------------------+---------------------------------------------------------------------------------------------------------------------+--------------------+
| CA                       |                                                                                                                     | dudi.coa           |
+--------------------------+---------------------------------------------------------------------------------------------------------------------+--------------------+
| Hill-Smith               | Aceita qualquer tipo de vari√°vel                                                                                    | dudi.hillsmith     |
+--------------------------+---------------------------------------------------------------------------------------------------------------------+--------------------+
| **Ordena√ß√£o restrita**   |                                                                                                                     |                    |
+--------------------------+---------------------------------------------------------------------------------------------------------------------+--------------------+
| RDA                      | Vari√°veis preditoras de qualquer tipo e vari√°veis dependentes cont√≠nuas (ou presen√ßa e aus√™ncia)                    | rda                |
+--------------------------+---------------------------------------------------------------------------------------------------------------------+--------------------+
| RDA parcial              | Vari√°veis preditoras de qualquer tipo e vari√°veis dependentes cont√≠nuas (ou presen√ßa e aus√™ncia)                    | rda                |
+--------------------------+---------------------------------------------------------------------------------------------------------------------+--------------------+
| dbRDA                    | Vari√°veis preditoras de qualquer tipo e matriz de dist√¢ncia obtida a partir das vari√°veis dependentes               | capscale, dbrda    |
+--------------------------+---------------------------------------------------------------------------------------------------------------------+--------------------+
| CCA                      | Vari√°veis preditoras de qualquer tipo e vari√°veis dependentes cont√≠nuas (ou presen√ßa e aus√™ncia)                    | rda                |
+--------------------------+---------------------------------------------------------------------------------------------------------------------+--------------------+
| PERMANOVA                | Vari√°veis preditoras de qualquer tipo e matriz de dist√¢ncia obtida a partir das vari√°veis dependentes               | adonis, adonis2    |
+--------------------------+---------------------------------------------------------------------------------------------------------------------+--------------------+
| PCR                      | Vari√°vel dependente necessariamente representada por escores da PCA ou PCoA e vari√°veis preditoras de qualquer tipo | pca, pcoa, lm, glm |
+--------------------------+---------------------------------------------------------------------------------------------------------------------+--------------------+

## Ordena√ß√µes irrestritas

## An√°lise de Componentes Principais - PCA

### Explica√ß√£o da an√°lise

A PCA √© uma das ordena√ß√µes mais utilizadas em diversas √°reas do conhecimento. Em ecologia, ela se popularizou por facilitar a visualiza√ß√£o de dados complexos como de distribui√ß√£o de esp√©cies em diferentes localidades e de potenciais vari√°veis explicativas. Ao mesmo tempo que ganhou tamanha popularidade, a PCA tem sido empregada de maneira incorreta, uma vez que muitos estudos utilizam a visualiza√ß√£o gr√°fica da ordena√ß√£o (o biplot) para intepretar "rela√ß√µes" entre vari√°veis preditoras (ambientais) e dependentes (esp√©cies). Por√©m, como informado anteriormente, as ordena√ß√µes irrestritas utilizam a estrutura de covari√¢ncia dos objetos para organizar suas rela√ß√µes de similaridade.

Antes de explicar a an√°lise, imagine que vamos usar uma matriz com cinco esp√©cies de aranhas que foram encontradas em oito cidades diferentes. A quantidade de indiv√≠duos de cada esp√©cie coletada em cada cidade ser√° o valor de preenchimento desta matriz. Sendo assim, a matriz possui oito objetos (cidades, representando unidades amostrais) e cinco descritores (esp√©cies), como na tabela abaixo:

| Cidade   | sp1 | sp2 | sp3 | sp4 | sp5 |
|----------|-----|-----|-----|-----|-----|
| Cidade 1 | 5   | 0   | 0   | 0   | 0   |
| Cidade 2 | 7   | 6   | 0   | 0   | 0   |
| Cidade 3 | 2   | 3   | 0   | 0   | 0   |
| Cidade 4 | 0   | 4   | 9   | 0   | 0   |
| Cidade 5 | 0   | 0   | 12  | 4   | 0   |
| Cidade 6 | 0   | 0   | 3   | 10  | 6   |
| Cidade 7 | 0   | 0   | 0   | 8   | 9   |
| Cidade 8 | 0   | 0   | 0   | 0   | 12  |

O primeiro passo da PCA √© obter uma matriz centralizada onde o valor de cada valor √© subtra√≠do da m√©dia da coluna que aquele valor pertence. Esta centraliza√ß√£o pode ser calculada com a fun√ß√£o scale.

```{r}

aranhas <- data.frame(sp1 = c(5, 7, 2, 0, 0, 0, 0, 0),
                      sp2 = c(0, 6, 3, 4, 0, 0, 0, 0),
                      sp3 = c(0, 0, 0, 9, 12, 3, 0, 0),
                      sp4 = c(0, 0, 0, 0, 4, 10, 8, 0),
                      sp5 = c(0, 0, 0, 0, 0, 6, 9, 12),
                      row.names = paste("cidade", 1:8, sep=""))

aranha.cent <- as.data.frame(base::scale(aranhas, center = TRUE, scale=FALSE))


```

O segundo passo √© calcular uma matriz de covari√¢ncia (ou matriz de dispers√£o) e, a partir desta matriz, obter os autovalores e autovetores. Os autovalores representam a porcentagem de explica√ß√£o de cada eixo e podem ser calculados dividindo a soma do autovalor de cada eixo pela soma de todos os autovalores. No exemplo que apresentamos, os dois primeiros eixos representam 47,20% e 35,01%, respectivamente, de toda varia√ß√£o. Os autovetores, por sua vez, representam os valores que multiplicam as vari√°veis originais e, desse modo, indicam a dire√ß√£o desses valores. Por fim, os componentes principais (Matriz F) s√£o obtidos multiplicando os autovetores com os valores da matriz centralizada.

```{r}

matriz_cov <- cov(aranha.cent)

eigen_aranhas <- eigen(matriz_cov)

autovalores<- eigen_aranhas$values
autovetores <- as.data.frame(eigen_aranhas$vectors)
autovalores # eigenvalue

colnames(autovetores) <- paste("PC", 1:5, sep="")
rownames(autovetores) <- colnames(aranhas)
autovetores


matriz_F <- as.data.frame(as.matrix(aranha.cent)%*%as.matrix(autovetores))
matriz_F
## Porcentagem de explica√ß√£o de cada eixo

100* (autovalores / sum(autovalores))

```

Agora, √© poss√≠vel visualizar a rela√ß√£o entre as cidadesem rela√ß√£o a similaridade na esp√©cies de aranhas que vivem em cada uma delas.

```{r}

matriz_F %>% 
  ggplot(aes(x = PC1, 
             y = PC2, 
             label = rownames(matriz_F))) +
  theme_bw() + 
  geom_label() + 
  geom_hline(yintercept = 0, linetype=2) +
  geom_vline(xintercept = 0, linetype=2) + 
  theme(axis.title.x = element_text(size=14),
        axis.text.x = element_text(vjust=0.5, 
                                   size=12), 
        axis.title.y = element_text(size=14),
        axis.text.y = element_text(vjust=0.5, 
                                   size=12))

```

**Checklist**

-   Verifique se todas as vari√°veis utilizadas s√£o cont√≠nuas. Caso contr√°rio, considere utilizar PCoA.

-   Apesar do exemplo acima ter apresentado a ocorr√™ncia de esp√©cies de aranhas em diferentes cidades, √© fundamental saber que utilizar PCA com esses dados pode ser problem√°tico. Assim, tenha cuidado em usar de composi√ß√£o de esp√©cies (especialmente abund√¢ncia) com PCA, uma vez que 'duplos zeros' podem gerar distor√ß√µes na ordena√ß√£o (Legendre & Legendre 2012). Como alternativa, √© poss√≠vel utilizar PCA (se precisar de espa√ßo euclideano) com dados padronizados com o m√©todo de Hellinger.

## Exemplo 1:

Neste exemplo vamos utilizar um conjunto de dados morfol√≥gicos de pinguins do arquip√©lago Palmer (Pen√≠nsula Ant√°rtica) dispon√≠veis no pacote 'palmerpenguins'. Os dados representam medidas do comprimento e largura do bico (mm), comprimento da nadadeira (mm) e massa corporal (gramas) de tr√™s esp√©cies: Ad√©lie, Chinstrap e Gentoo. Como descrito acima, a PCA deve ser utilizada para explora√ß√£o de dados ou para testes a posteriori (p. ex., PCR). Neste exemplo, iremos usar a estrutura de perguntas e predi√ß√µes para manter a proposta do livro.

**Pergunta:**

> O espa√ßo morfol√≥gico multidimensional das esp√©cies de pinguins do arquip√©lago Palmer √© diferente?

**Predi√ß√µes**

> Iremos encontrar ao menos dois grupos de esp√©cies: aquelas que ocorrem em po√ßas dentro de floresta vs. aquelas que ocorrem em po√ßas de √°reas abertas.

**Vari√°veis**

-   Preditora: esp√©cie (categ√≥rica com tr√™s n√≠veis)

-   Dependentes: vari√°veis morfol√≥gicas (cont√≠nua)

\#\#\# An√°lise

Para come√ßar, vamos importar todos os pacotes necess√°rios para a PCA e outras an√°lises deste cap√≠tulo

```{r message=FALSE, warning=FALSE}


library(vegan)
library(ggplot2)
library(gridExtra)
library(ape)
library(FactoMineR)
library(factoextra)
library(FD)
library(palmerpenguins)
library(tidyverse)
library(FD)
library(GGally)
library(ade4)
library(ggord)
library(adespatial)
library(spdep)

```

Depois, ser√° necess√°rio baixar todos os dados

```{r message=FALSE, warning=FALSE}

data(mite)
data(mite.env)
data(package = 'palmerpenguins')
species <- read.csv("com_birds.csv", sep=";", row.names = "X")
env <-  read.csv("env_birds.csv", sep=";", row.names = "X")
xy <- read.csv("birds.xy.csv", sep=";", row.names = "X")

```

e editar se for necess√°rio (remover dados ausentes, editar nomes das vari√°veis, etc...)

```{r message=FALSE, warning=FALSE}
# remover dados ausentes NA
penguins <- na.omit(penguins)

# editar nomes para aparecer nos gr√°ficos
names(penguins) <- c("species", "island", "Bill length", "Bill depth", "Flipper length", "Body mass", "Sex", "Year")

# Manter somentes dados cont√≠nuos que pretende aplicar a PCA

penguins_trait <- penguins[,3:6]
```

Agora sim os dados est√£o prontos para fazer a PCA. Um argumento √© essencial na an√°lise, o "scale.unit". Se voc√™ utiliar dentro deste argumento o sele√ß√£o 'TRUE', a fun√ß√£o padroniza automaticamente as vari√°veis para terem a m√©dia 0 e vari√¢ncia 1. Esta padroniza√ß√£o √© essencial quando as vari√°veis est√£o em escalas muito diferentes. No exemplo selecionado, temos vari√°veis como comprimento do bico (em mil√≠metros) e massa corporal (em gramas).

```{r message=FALSE, warning=FALSE}

# Compare com este c√≥digo a vari√¢ncia das vari√°veis
penguins_trait %>% 
  summarise(across(where(is.numeric), 
                   ~var(.x, na.rm=TRUE)))

# Agora, veja o mesmo c√°lculo se fizer a padroniza√ß√£o (scale.unit da fun√ß√£o PCA)
penguins_pad <- decostand(penguins_trait, "standardize")

penguins_pad %>% 
  summarise(across(where(is.numeric), 
                   ~var(.x, na.rm=TRUE)))

# PCA
pca.p <- PCA(penguins_trait, scale.unit = TRUE, graph = FALSE)

```

Apesar da simplicida do comando para executar a PCA, o objeto resultante da an√°lise possui diversas informa√ß√µes que s√£o essenciais para sua plena interpreta√ß√£o. Dentre elas, se destacam os autovalores, escores e *loadings*. Os autovalores representam a porcentagem de explica√ß√£o de cada eixo. O escores representam as coordenadas (posi√ß√µes no espa√ßo multidimensional) representando os objetos (geralmente localidades ou indiv√≠duos) e descritores (geralmente esp√©cies ou vari√°veis ambientais e espaciais). Os *loadings*, por sua vez, representam a combina√ß√£o linear entre os escores (nova posi√ß√£o do valor do descritor no espa√ßo ordenado) e os valores originais dos descritores.

```{r message=FALSE,warning=FALSE}


## Autovalores: porcentagem de explica√ß√£o para usar no gr√°fico
pca.p$eig 

## Visualiza√ß√£o da porcentagem de explica√ß√£o de cada eixo
# nota: √© necess√°rio ficar atento ao valor m√°ximo do eixo 1 da an√°lise para determinar o valor do ylim (neste caso, colocamos que o eixo varia de 0 a 70)

fviz_screeplot(pca.p, addlabels = TRUE, ylim = c(0, 70)) 

## Outros valores importantes

var_env <- get_pca_var(pca.p)

# Escores (posi√ß√£o) das vari√°veis em cada eixo
var_env$coord 

# Contribui√ß√£o (%) das vari√°veis para cada eixo
var_env$contrib 

# loadings - correla√ß√£o das vari√°veis com os eixos
var_env$cor 

# Qualidade da representa√ß√£o da vari√°vel. Esse valor √© obtido multiplicado var_env$coord por var_env$coord

var_env$cos2

# Escores (posi√ß√£o) das localidades ("site scores") em cada eixo 
ind_env <- get_pca_ind(pca.p)

```

O pacote FactoMineR criou uma fun√ß√£o (dimdesc) que seleciona as melhores vari√°veis (aquelas mais explicativas) para cada eixo atrav√©s de uma an√°lise fatorial. No exemplo com pinguins, o primeiro eixo (objeto pca.p\$eig) explica \~69% da varia√ß√£o morfol√≥gica. A fun√ß√£o dimdesc mostra que as quatro vari√°veis morfol√≥gicas est√£o fortemente associadas com o eixo 1. Por√©m, enquanto comprimento da nadadeira, massa corporal e comprimento do bico est√£o positivamente associados com o eixo 1 (correla√ß√£o positiva), a largura do bico tem rela√ß√£o negativa. O eixo 2, por sua vez, explica \~20% da varia√ß√£o, sendo relacionado somente com largura e comprimento do bico.

```{r message=FALSE, warning=FALSE}

# Vari√°veis mais importantes para o Eixo 1
dimdesc(pca.p)$Dim.1 

# Vari√°veis mais importantes para o Eixo 3
dimdesc(pca.p)$Dim.2 

```

Agora podemos utilizar o famoso "biplot" para representar a compara√ß√£o morfol√≥gica dos pinguins dentro e entre esp√©cies

```{r message=FALSE, warning=FALSE}

fviz_pca_biplot(pca.p,
                geom.ind = "point",                                        
                fill.ind = penguins$species, 
                col.ind = "black",
                alpha.ind=0.7,
                pointshape = 21, 
                pointsize = 3,
                palette = "jco",
                addEllipses = FALSE,
                alpha.var = 1,
                col.var = "black",
                gradient.cols = "RdBu",
                invisible = "quali",
                title = NULL) +
  theme_bw() + 
  xlab("PC 1 (68.63%)") + 
  ylab("PC 2 (19.45%)") + 
  theme(axis.title.x = element_text(size=14),
        axis.text.x = element_text(vjust=0.5, 
                                   size=12),
        axis.title.y = element_text(size=14),
        axis.text.y = element_text(vjust=0.5, 
                                   size=12),
        legend.position = "top",
        legend.title = element_blank())

```

## An√°lise de Coordenadas Principais - PCoA

### Explica√ß√£o da an√°lise

Diferentemente da PCA, a PCoA √© uma an√°lise de ordena√ß√£o irrestrita que aceita dados de diferentes tipos, como cont√≠nuos, categ√≥ricos, ordinais, bin√°rios, entre outros. Assim, a PCoA √© aplicada para casos em que a dist√¢ncia euclideana n√£o √© aplicada (como na PCA). Desse modo, o primeiro passo da an√°lise √© calcular uma matriz de similaridade ou de dist√¢ncia (**veja cap√≠tulo XXX**). Depois, os passos para obter autovalores e autovetores s√£o bastante parecidos com a PCA. Da mesma forma, os eixos da PCoA e os valores ou posi√ß√µes dos objetos nesses eixos representam a rela√ß√£o de semelhan√ßa (ou diferen√ßa) baseada nos descritores desses objetos. A diferen√ßa, neste caso, √© que a PCoA representa um espa√ßo n√£o-euclideano, que ir√° ser afetado pela escolha do m√©todo de similaridade.

As utiliza√ß√µes mais comuns da PCoA s√£o a ordena√ß√£o (1) da matriz de composi√ß√£o de esp√©cies usando a dist√¢ncia apropriada (Jaccard, Sorensen, Bray Curits), (2) da matriz de vari√°veis ambientais com mistos (cont√≠nuos, categ√≥ricos, circulares, etc...), e (3) da matriz filogen√©tica (m√©todo PVR: Diniz-Filho et al. 1998). Abaixo, exemplificamos a ordena√ß√£o da matriz de composi√ß√£o de esp√©cies.

**Checklist**

-   Compare as dimens√µes das matrizes utilizadas para a PCoA. Com bastante frequ√™ncia, a tentativa de combinar dados categ√≥ricos (algum descritor dos objetos) com os valores obtidos com a PCoA gera erros para plotar a figura ou para executar a an√°lise. Verifique, ent√£o, se as linhas s√£o as mesmas (nome das localidades ou indiv√≠duos e quantidade).

-   √â fundamental conhecer o tipo de dados que est√° usando para selecionar a medida de dist√¢ncia apropriada. Essa escolha vai afetar a qualidade da ordena√ß√£o e sua habilidade para interpretar a rela√ß√£o de semelhan√ßa entre os objetos comparados.

-   Diferente da PCA, a PCoA aceita dados ausentes se a medida de dist√¢ncia escolhida tamb√©m n√£o tiver esta limita√ß√£o. Por exemplo, a dist√¢ncia de Gower produz matrizes de similaridade mesmo com dados ausentes em determinados objetos.

-   Em alguns casos, a autovalores negativos s√£o produzidos na ordena√ß√£o com PCoA (veja as principais causas desses valores em Legendre & Legendre 2012, cap√≠tulo 9). Apesar deste problema, os autovalores mais importantes (eixos iniciais) n√£o s√£o afetados e, deste modo, a qualidade da representa√ß√£o dos objetos no espa√ßo multidimensional n√£o √© afetada. Alguns autores sugerem utilizar corre√ß√µes m√©todos de corre√ß√£o, como Lingoes ou Cailliez (Legendre & Legendre 2012).

## Exemplo 1:

Neste exemplo vamos utilizar a composi√ß√£o de √°caros Oribatidae em 70 manchas de musgo coletados por Borcard et al. (1992).

**Pergunta:**

> A composi√ß√£o de esp√©cies de √°caros muda entre diferentes topografias?

**Predi√ß√µes**

> Iremos encontrar ao menos dois grupos de esp√©cies: aquelas que ocorrem em po√ßas dentro de floresta vs. aquelas que ocorrem em po√ßas de √°reas abertas.

**Vari√°veis**

-   Preditora: topografia (categ√≥rica com dois n√≠veis)

-   Dependentes: composi√ß√£o de esp√©cies de √°caro

\#\#\# An√°lise

```{r message=FALSE, warning=FALSE}

# Padroniza√ß√£o dos dados com Hellinger
mite.hel <- decostand(mite, "hellinger") 

# C√°lculo da matriz de dist√¢ncia com m√©todo Bray Curtos
sps.dis <- vegdist(mite.hel, "bray") 

# PCoA
pcoa.sps <- pcoa(sps.dis, correction="cailliez")

```

Assim como na PCA, a porcentagem de explica√ß√£o dos eixos √© uma das informa√ß√µes mais importantes pois descrevem a efetividade da redu√ß√£o da dimensionalidade dos dados.

```{r message=FALSE, warning=FALSE}

## Porcentagem de explica√ß√£o do Eixo 1
100*(pcoa.sps$values[,1] / pcoa.sps$trace)[1]

## Porcentagem de explica√ß√£o dos Eixo 2
100*(pcoa.sps$values[,1] / pcoa.sps$trace)[2]

## Porcentagem de explica√ß√£o acumulada dos dois primeiros eixos 
sum(100*(pcoa.sps$values[,1] / pcoa.sps$trace)[1:2])


eixos <- pcoa.sps$vectors[,1:2] # Selecionar os dois primeiros eixos

## Juntar com algum dado categ√≥rico de interesse para fazer a figura
pcoa.dat <- data.frame(topografia=mite.env$Topo, eixos)


```

Para visualizar os resultados da PCoA, vamos exportar os escores dos eixos para usar no ggplot2.

```{r message=FALSE, warning=FALSE}

## Escores dos dois primeiros eixos
eixos <- pcoa.sps$vectors[,1:2] 

## Combinar dados dos escores com um dado categ√≥rico de interesse para nossa pergunta

pcoa.dat <- data.frame(topografia=mite.env$Topo, eixos)

### Gr√°fico biplot da PCoA

pcoa.dat %>%
  ggplot(aes(x = Axis.1, 
             y = Axis.2, 
             fill = topografia, 
             color = topografia, 
             shape = topografia)) +
  theme_bw() +
  geom_point(size=3, alpha = 0.7) + 
  scale_shape_manual(values=c(21, 22)) + 
  scale_color_manual(values=c("black", "black")) + 
  scale_fill_manual(values=c("#d73027", "#4575b4")) + 
  xlab("PCO 1 (49.11%)") + ylab("PCO 2 (14.30%)") + 
  theme(axis.title.x = element_text(face="bold", size=14),
        axis.text.x = element_text(vjust=0.5, size=12),
        axis.title.y = element_text(face="bold", size=14),
        axis.text.y = element_text(vjust=0.5, size=12),
        legend.position = "top", 
        legend.title=element_blank()) + 
  geom_hline(yintercept = 0, linetype=2) + 
  geom_vline(xintercept = 0, linetype=2)

ggsave("pcoa_fig.pdf", height = 14, width = 14, dpi = 900, units = "cm")
ggsave("pcoa_fig.png", height = 14, width = 14, dpi = 900, units = "cm")

```

### Limita√ß√µes importantes das ordena√ß√µes irrestritas

Com frequ√™ncia, pesquisadores utilizam an√°lises como PCA e PCoA para "testar" diferen√ßas na composi√ß√£o de esp√©cies entre determinados fatores relevantes (altitude, clima, etc...). Por√©m, como falado acima, as an√°lises de ordena√ß√£o irrestritas n√£o s√£o utilizadas para testar qualquer hip√≥tese. Ao inv√©s disso, essas an√°lises representam uma poderosa ferramente para explorar padr√µes em vari√°veis dependentes ou independentes para ajudar na interpreta√ß√£o ou mesmo para testar hip√≥teses em an√°lises combinadas com as ordena√ß√µes irrestritas.

## PCR - Regress√£o de Componentes Principais

### Explica√ß√£o da an√°lise

Uma maneira de testar hip√≥teses utilizando ordena√ß√µes irrestritas √© utilizando os resultados da ordena√ß√£o (escores) como vari√°veis preditoras ou dependentes como, por exemplo, em modelos lineares (e.g., regress√£o m√∫ltipla). O primeiro passo √© utilizar uma ordena√ß√£o, como a PCA, para gerar os "novos" dados que ser√£o usados na an√°lise. A utiliza√ß√£o desses novos dados (que representam as coordenadas principais ou escores da PCA) vai depender da pergunta em quest√£o. Por exemplo, pode ser que esses valores representem gradientes clim√°ticos e, por este motivo, ser√£o utilizados como vari√°veis preditoras em um modelo linear (e.g., regress√£o m√∫ltipla). Por outro lado, esses valores podem representar o espa√ßo morfol√≥gicos de esp√©cies de peixe e, como consequ√™ncia, ser√£o utilizados como vari√°veis dependentes para entender o efeito da presen√ßa de predador sobre a morfologia.

**Checklist**

-   Compare as dimens√µes das matrizes utilizadas para a PCR. Com bastante frequ√™ncia, a tentativa de combinar dados categ√≥ricos (algum descritor dos objetos) com os valores obtidos com a PCoA gera erros para plotar a figura ou para executar a an√°lise. Verifique, ent√£o, se as linhas s√£o as mesmas (nome das localidades ou indiv√≠duos e quantidade).

-   Estudos recentes t√™m criticado a utiliza√ß√£o de PCR para testar hip√≥teses ecol√≥gicas pelo fato dos escores n√£o representarem, necessariamente, a varia√ß√£o total das vari√°veis originais, bem como a rela√ß√£o entre a vari√°vel preditora e a dependente.

## Exemplo 1:

Neste exemplo vamos utilizar a composi√ß√£o de esp√©cies de aves em 23 regi√µes dos alpes franceses. Os dados ambientais (env) representam vari√°veis clim√°ticas (temperatura e chuva) e altitude.

**Pergunta:**

> Gradientes clim√°ticos afetam a riqueza de aves?

**Predi√ß√µes**

> O aumento da umidade e redu√ß√£o da temperatura favorecem o n√∫mero de esp√©cies de aves.

**Vari√°veis**

-   Preditora: temperatura e chuva (cont√≠nuas) e altitude (categ√≥rica com tr√™s n√≠veis)

-   Dependentes: riqueza de esp√©cies de aves

```{r message=FALSE, warning=FALSE}

env_cont <- env[,-8]
env.pca <- PCA(env_cont, scale.unit = TRUE, graph = FALSE)
var_env <- get_pca_var(env.pca) 

# Contribui√ß√£o (%) das vari√°veis para cada eixo
var_env$contrib 

# Loadings - correla√ß√£o das vari√°veis com os eixos
var_env$cor 

ind_env <- get_pca_ind(env.pca)

env.pca$eig 

```

O argumento env.pca\$eig demonstra que os tr√™s primeiros eixos explicam 94.54% da varia√ß√£o total dos dados clim√°ticos. Como o intuito da PCR √© reduzir a dimensionalidade (ou seja, o n√∫mero de vari√°veis preditoras ou depedentes) para facilitar a interpreta√ß√£o e garantir que as vari√°veis n√£o sejam correlacionadas. O pr√≥ximo passo ent√£o √© obter os valores dos escores que representam os valores convertidos para serem usados em uma determinada an√°lise, como a regress√£o m√∫ltipla.

```{r}

# Passo 1: obter os primeiros eixos 
pred.env <- ind_env$coord[,1:3] 

# Passo 2: calcular a riqueza de esp√©cies
riqueza <- specnumber(species)

# Passo 3: combinar os dois valores em um √∫nico data.frame
dat <- data.frame(pred.env, riqueza) 
```

Agora que os dados foram combinados em uma √∫nica matriz, podemos utilizar os comandos aprendidos no *Cap√≠tulo XXX* para testar nossa hip√≥tese.

```{r}

# Regress√£o m√∫ltipla

mod1 <- lm(riqueza~Dim.1+Dim.2+Dim.3, data = dat)

plot(mod1) # verificar pressupostos dos modelos lineares

summary(mod1) # resultados do  teste

dimdesc(env.pca)$Dim.1 
```

Como percebemos, a Dim.1 foi o √∫nico gradiente ambiental que afetou a riqueza de esp√©cies. Para interpretar esta dimens√£o (e outras importantes), podemos usar a fun√ß√£o dimdesc para verificar as vari√°veis mais importantes. Neste caso, os valores mais extremos de correla√ß√£o (maior que 0.8) indicam que a temperatura do m√™s de janeiro e julho bem como a chuva do m√™s de julho foram as vari√°veis mais importantes para determinar o gradiente ambiental expresso na dimens√£o 1. Assim, podemos fazer um gr√°fico para representar a rela√ß√£o entre Eixo 1 (gradiente chuva-temperatura) e a riqueza de esp√©cies de aves. Valores negativos do eixo 1 (Gradiente ambiental - PC1) representam localidades com mais chuva, ao passo que valores positivos indicam localidades com temperaturas maiores.

```{r message=FALSE, warning=FALSE}

dat %>% 
  ggplot(aes(x = Dim.1, y = riqueza)) + 
  theme_bw() +
  geom_smooth(method = lm, 
              fill = "#67a9cf",
              color = "#1a1a1a") + 
  geom_point(size=2, 
             shape=21,
             alpha = 0.7,
             color="#1a1a1a",
             fill="#4d4d4d") +
  xlab("Gradiente ambiental (PC1)") + 
  ylab("Riqueza de aves") + 
  theme(axis.title.x = element_text(size=14),
        axis.text.x = element_text(vjust=0.5, 
                                   size=12),
        axis.title.y = element_text(size=14),
        axis.text.y = element_text(vjust=0.5, 
                                   size=12))
```

## Exemplo 2:

√â poss√≠vel que os dados utilizados em seu estudo sejam mistos, ou seja, incluem tanto vari√°veis categ√≥ricas quanto cont√≠nuas. Como falado acima, nesses casos a an√°lise indicada √© a PCoA. Assim como na PCA, podemos extrair os escores da PCoA para utilizar a posteriori em an√°lises univariadas e multivariadas.

**Pergunta:**

> Vari√°veis clim√°ticas, vegetacionais e topogr√°ficas afetam a riqueza de √°caros?

**Predi√ß√µes**

> A densidade da vegeta√ß√£o e disponibilidade de √°gua aumentam a riqueza de esp√©cies de √°caros.

**Vari√°veis**

-   Preditoras: densidade de substrado e disponibilidade de √°gua (cont√≠nuas), tipo de substrado (categ√≥rica com 7 n√≠veis), densidade arbusto (ordinal com 3 n√≠veis), e topografia (categ√≥rica com 2 n√≠veis)

-   Dependentes: riqueza de esp√©cies de √°caros

O primeiro passo ent√£o √© utilizar um m√©todo de dist√¢ncia apropriado para o seu conjunto de dados. Em nosso exemplo, utilizaremo a dist√¢ncia de Gower.

```{r message=FALSE, warning=FALSE}

## Matriz de dist√¢ncia
env.dist <- gowdis(mite.env)

## PCoA
env.mite.pco <- pcoa(env.dist, correction="cailliez")

## Porcentagem de explica√ß√£o do Eixo 1
100*(env.mite.pco$values[,1] / env.mite.pco$trace)[1]

## Porcentagem de explica√ß√£o dos Eixo 2
100*(env.mite.pco$values[,1] / env.mite.pco$trace)[2]


```

O pr√≥ximo passo √© exportar os escores para as an√°lises a posteriori.

```{r message=FALSE, warning=FALSE}

# Selecionar os dois primeiros eixos

pred.scores.mite <- env.mite.pco$vectors[,1:2] 

### Juntar com os dados da √°rea para fazer a figura 

mite.riqueza <- specnumber(mite)

pred.vars <- data.frame(riqueza=mite.riqueza, pred.scores.mite)

### Regress√£o m√∫ltipla 

mod.mite <- lm(riqueza~Axis.1+Axis.2, data=pred.vars)

plot(mod.mite)

summary(mod.mite)

```

Finalmente, ap√≥s interpretar os resultados do modelo, podemos fazer a figura com as vari√°veis (eixos) importantes

```{r message=FALSE, warning=FALSE}

g_acari_axi1 <- pred.vars %>% 
  ggplot(aes(x = Axis.1, y = riqueza)) + 
  theme_bw() + 
  geom_smooth(method = lm, 
              fill = "#67a9cf",
              color = "#1a1a1a") + 
  geom_point(size=2, 
             shape=21,
             alpha = 0.7,
             color="#1a1a1a",
             fill="#4d4d4d") + 
  xlab("Gradiente ambiental (PC1)") +
  ylab("Riqueza de √°caros") + 
  theme(axis.title.x = element_text(size=14),
        axis.text.x = element_text(vjust=0.5, 
                                   size=12), 
        axis.title.y = element_text(size=14),
        axis.text.y = element_text(vjust=0.5,
                                   size=12))

g_acari_axi2 <-pred.vars %>% 
  ggplot(aes(x = Axis.2, y = riqueza)) + 
  theme_bw() + 
  geom_smooth(method = lm, 
              fill = "#67a9cf",
              color = "#1a1a1a") +
  geom_point(size=2, 
             shape=21,
             alpha = 0.7,
             color="#1a1a1a",
             fill="#4d4d4d") + 
  xlab("Gradiente ambiental (PC2)") + 
  ylab("Riqueza de √°caros") + 
  theme(axis.title.x = element_text(size=14),
        axis.text.x = element_text(vjust=0.5,
                                   size=12), 
        axis.title.y = element_text(size=14),
        axis.text.y = element_text(vjust=0.5, 
                                   size=12))

grid.arrange(g_acari_axi1, g_acari_axi2, nrow=1)

```

# Ordena√ß√£o restrita

A ordena√ß√£o restritas ou an√°lises de gradiente direto representam, como falado anteriormente, ordena√ß√µes que organizam os objetos de acordo com suas rela√ß√µes com outras vari√°veis (preditoras) coletadas nas mesmas unidades amostrais. O exemplo mais comum na ecologia √© de investigar a rela√ß√£o entre diversas vari√°veis ambientais (matriz **X**) coletadas em *n* localidades e a abund√¢ncia (ou presen√ßa aus√™ncia) de *y* esp√©cies coletadas nas mesmas localidades (matrix **Y**). Com frequ√™ncia, outras dados s√£o utilizados como as coordenadas geogr√°ficas das unidades amostrais (matriz **W**), os atributos funcionais das esp√©cies coletadas (matriz **T**) e a rela√ß√£o filogen√©tica dessas esp√©cies (matriz **P**). Diversos m√©todos s√£o utilizados para combinar duas ou mais matrizes, mas neste cap√≠tulo iremos apresentar a RDA, RDAp e m√©todos espaciais para incluir a matriz W nas an√°lises de gradiente direto.

## RDA: An√°lise de Redund√¢ncia

A RDA √© uma an√°lise semelhante a regress√£o m√∫ltipla (**Cap√≠tulo XXX**) mas que usa dados multivariados como vari√°vel dependente. As duas matrizes comuns, matriz X (*n* unidades amostraits e *m* vari√°veis) e matriz Y (*n* unidades amostrais e *p* descritores - geralmente, esp√©cies). O primeiro passo da RDA √© centralizar (assim como na PCA, exemplo acima) as matrizes X e Y. Ap√≥s a centraliza√ß√£o, realiza-se regress√µes lineares entre X e Y para obter os valores preditos de Y (ou seja, os valores de Y que representa√ß√£o uma combina√ß√£o linear com X). O passo seguinte √© realizar uma PCA dos valores preditos de Y. Este √∫ltimo procedimento gera os autovalores, autovetores e os eixos can√¥nicos que correspondem √†s coordenadas dos objetos (unidades amostrais), vari√°veis preditoras e das vari√°veis resposta. A diferen√ßa da ordena√ß√£o do valor de Y predito e da ordena√ß√£o somente de Y (como na PCA implementada acima) √© que a segunda mostra a posi√ß√£o prevista pela rela√ß√£o linear entre X e Y. Logo, essa √© exatamente o motivo da ordena√ß√£o ser conhecida como restrita, pois a varia√ß√£o em Y √© restrita (linearmente) pela varia√ß√£o de X. Assim como na regress√£o m√∫ltipla, a estat√≠stica da RDA √© representada pelo valor de *R^2^* e *F*. O valor de *R^2^* indica a for√ßa da rela√ß√£o linear entre X e Y e o valor do *F* representa o teste global de signific√¢ncia. Al√©m disso, √© poss√≠vel testar a signific√¢ncia de cada um dos eixos da ordena√ß√£o (e a presen√ßa de pelo menos um eixo significativo √© pr√©-requisito para que exista a rela√ß√£o linear entre X e Y) e de cada uma das vari√°veis preditoras da matriz X.

**Checklist**

-   Vari√°veis preditoras: importante verificar (1) a estrutura de correla√ß√£o das vari√°veis ambientais, e a (2) presen√ßa de autocorrela√ß√£o espacial.

-   Composi√ß√£o de esp√©cies como matriz Y: fundamental observar se os valores utilizados representam abund√¢ncia ou presen√ßa-aus√™ncia e qual a necessidade de padroniza√ß√£o (e.g., Hellinger).

-   Assim como em modelos de regress√£o linear e m√∫ltipla, os valores de *R^2^* ajustado devem ser selecionados ao inv√©s do valor de *R^2^*.

## Exemplo 1:

Esp√©cies de aves que ocorrem em localidades com diferentes altitudes.

**Pergunta:**

> O clima e a altitude modificam a composi√ß√£o de esp√©cies de aves?

**Predi√ß√µes**

> Diferen√ßas clim√°ticas (temperatura e chuva) e altitudinais alteram a composi√ß√£o de esp√©cies de aves.

**Vari√°veis** (mesmo conjunto de dados usados na PERMANOVA)

-   Preditoras: Temperatura e chuva (cont√≠nuas) e altitude (categ√≥rica com tr√™s n√≠veis)

-   Dependente: composi√ß√£o de esp√©cies de aves

```{r message=FALSE, warning=FALSE}

## Primeiro: transforma√ß√£o de hellinger da matriz de esp√©cies

## caso tenha dados de abund√¢ncia

species.hel <- decostand(species, "hellinger")

## Segundo, selecionar vari√°veis importantes
# Para isso, √© necess√°rio remover a vari√°vel categ√≥rica
env.contin <- env[,-8]

## Evite usar vari√°veis muito correlacionadas

sel.vars <- forward.sel(species.hel, env.contin)
sel.vars$variables

env.sel <- env[,sel.vars$variables]

## Terceiro: padronizar matriz ambiental (somente vari√°veis cont√≠nuas)

env.pad <- decostand(env.sel, "standardize")

## Matriz final com vari√°veis preditoras
env.pad.cat <- data.frame(env.pad, altitude = env$altitude)

```

Depois de selecionar um subconjunto dos dados com o m√©todo Forward Selection e padroniz√°-los (m√©dia 0 e desvio padr√£o 1), o modelo da RDA √© constru√≠do como modelos lineares e PERMANOVA.

```{r}
## RDA com dados selecionados e padronizados


rda.bird <- rda(species.hel~rain.jul+maxi.jul+altitude, data=env.pad.cat)

summary(rda.bird)

# Para interpretar, √© necess√°rio saber a signific√¢ncia dos eixos para representar a rela√ß√£o entre as vari√°veis preditoras e a composi√ß√£o de esp√©cies

res.axis <- anova.cca(rda.bird, by="axis") 

res.axis

# Em seguida, √© poss√≠vel identificar quais s√£o as vari√°veis que contribuem ou que mais contribuem para a varia√ß√£o na composi√ß√£o de esp√©cies 

res.var <- anova.cca(rda.bird, by="term") ## Qual vari√°vel?

res.var

# Al√©m disso, √© poss√≠vel obter o valor do R2 do modelo
RsquareAdj(rda.bird)


# Ordena√ß√£o multi-escala (MSO) para entender os resultados da ordena√ß√£o em rela√ß√£o √† dist√¢ncia geogr√°fica

bird.rda <- mso(rda.bird, xy, grain =  1, permutations = 99)
msoplot(bird.rda)


### Triplot da RDA

ggord(rda.bird, 
      ptslab = TRUE, 
      size = 1, 
      addsize = 3, 
      parse = TRUE) +
  theme_bw() + 
  geom_hline(yintercept = 0, linetype=2) +
  geom_vline(xintercept = 0, linetype=2) + 
  theme(axis.title.x = element_text(size=14),
        axis.text.x = element_text(vjust=0.5, 
                                   size=12), 
        axis.title.y = element_text(size=14),
        axis.text.y = element_text(vjust=0.5, 
                                   size=12))


```

## RDAp: An√°lise de Redund√¢ncia parcial

Um dos problemas da abordagem anterior √© que tanto a composi√ß√£o de esp√©cies como as vari√°veis ambientais est√£o estruturadas espacialmente. Talvez mais importantes, para que os valores de probabilidade da RDA sejam interpretados corretamente (e para evitar erro do tipo I), os res√≠duos do modelo n√£o devem estar correlacionados espacialmente, como demonstrado com a an√°lise MSO. Uma alternativa √© de incluir a matriz de dados espaciais (matrix W) como valor condicional dentro da RDA. Esta an√°lise √© conhecida como RDA parcial.

Por√©m, a obten√ß√£o dos dados espaciais da matriz W √© mais complexo do que simplesmente incluir dados de localiza√ß√£o geogr√°fica (latitude e longitude), como feito em alguns modelos lineares (gls, Cap√≠tulo XXX). Existem diversas ferramentas que descrevem e incorporam o componente espacial em m√©todos mulitidimensionais, mas os Mapas de autovetores de Moran (MEM) s√£o certamente os mais utilizados (Dray et al. 2012). A an√°lise MEM consiste na ordena√ß√£o (PCoA) de uma matriz truncada obtida atrav√©s da localiza√ß√£o geogr√°fica das localidades utilizando dist√¢ncia euclideana, matriz de conectividade e matriz espacial ponderada. Os autovalores obtidos no MEM s√£o id√™nticos aos coeficientes de correla√ß√£o espacial de Moran *I*. Um procedimento chave desta an√°lise √© a defini√ß√£o de um limiar de trucamento (do ingl√™s *truncate threshold*). Este limiar √© calculado a partir de uma "√°rvore de espa√ßo m√≠nimo" (MST, do ingl√™s *minimum spanning tree*) que conecta todos os pontos de coleta. Na pr√°tica, os valores menores do que o limiar definido pela MST indicam que os pontos com aqueles valores est√£o conectados e, assim possuem correla√ß√£o positiva. Outro ponto importante desta an√°lise √© a obten√ß√£o da matriz espacial ponderada (SWM, do ingl√™s *spatial weighthing matrix*). A sele√ß√£o da matriz SWM √© parte essencial do c√°lculo dos MEM e n√£o deve ser feita arbitratiamente (Bauman et al. 2018a). Por este motivo a an√°lise recebe este nome (Legendre & Legendre 2012). Finalmente, o m√©todo produz autovetores que representam preditores espaciais que podem ser utilizados na RDA parcial (e outras an√°lises). √â importante ressaltar que o crit√©rio de sele√ß√£o do n√∫mero de autovetores √© bastante debatido na literatura e, para isso, sugerimos a leitura dos seguintes artigos: Diniz-Filho et al. 2012, Bauman et al. 2018a, b.

Ent√£o, o primeiro passo para realizar uma RDA parcial √© de gerar os autovetores espaciais (MEMs).

```{r message=FALSE, warning=FALSE}

# Dados necess√°rios 

species.hel # matriz padronizada de composi√ß√£o de esp√©cies 
xy # latitude e longitude
env.pad.cat # dados ambientais padronizados e altitude


# 1. Gerar um arquivo LIST W: list bin√°ria de vizinhan√ßa

mat_knn <- knearneigh(as.matrix(xy), k=2, longlat = FALSE)
mat_nb <- knn2nb(mat_knn, sym=TRUE)
mat_listw <- nb2listw(mat_nb, style = "W")
mat_listw

# 2. Listar os m√©todos "candidatos" para obter a matriz SWM

MEM_mat <- scores.listw(mat_listw, MEM.autocor = "positive")
candidates <- listw.candidates(xy, nb = c("gab", "mst", "dnear"), weights = c("binary", "flin"))

# 3. Selecionar a melhor matriz SWM e executar o MEM

W_sel_mat <- listw.select(species.hel, candidates, MEM.autocor = "positive", p.adjust = TRUE, method = "FWD")

# 4. Matriz dos preditores espaciais escolhidos (MEMs)

spatial.pred <- as.data.frame(W_sel_mat$best$MEM.select)
rownames(spatial.pred) <- rownames(xy) # necess√°rio atribuir os nomes das linhas


```

Depois de gerar os valores dos autovetores espaciais (MEM), √© poss√≠vel executar a a RDA parcial utilizando esses valores no argumento 'Conditional'.

```{r message=FALSE, warning=FALSE}


pred.vars <- data.frame(env.pad.cat, spatial.pred)

names(pred.vars)

rda.p <- rda(species.hel ~
               rain.jul + maxi.jul + altitude + # Preditores ambientais
               Condition(MEM1+MEM2+MEM4+MEM5), # Preditores espaciais
             data = pred.vars)


# Para interpretar, √© necess√°rio saber a signific√¢ncia dos eixos para representar a rela√ß√£o entre as vari√°veis preditoras e a composi√ß√£o de esp√©cies

res.p.axis <- anova.cca(rda.p, by="axis") 

res.p.axis

# Em seguida, √© poss√≠vel identificar quais s√£o as vari√°veis que contribuem ou que mais contribuem para a varia√ß√£o na composi√ß√£o de esp√©cies 

res.p.var <- anova.cca(rda.p, by="term") ## Qual vari√°vel?

res.p.var

RsquareAdj(rda.p)



```

Se voc√™ comparar os resultados do objeto res.p.var (RDA parcial) com res.var (RDA simples) √© poss√≠vel perceber como a estrutura espacial nos res√≠duos aumenta a probabilidade de cometer erro do tipo 1. O modelo da RDA parcial mostra que n√£o existem qualquer efeito direto das vari√°veis ambientais sobre a composi√ß√£o de esp√©cies (conclus√£o com a RDA simples). Na verdade, tanto a composi√ß√£o de esp√©cies quanto as vari√°veis clim√°ticas est√£o fortemente estruturadas no espa√ßo, como demonstramos nas figuras a seguir:

```{r}
### Padr√£o espacial na composi√ß√£o de esp√©cies

pca.comp <- dudi.pca(species.hel, scale = FALSE, scannf = FALSE)
moran.comp <- moran.mc(pca.comp$li[, 1], mat_listw, 999)

# Gr√°fico
adegraphics::s.value(xy, pca.comp$li[, 1], symbol = "circle",sub = paste("MC =", round(moran.comp$statistic, 3)),pSp.col = "grey")

### Padr√£o espacial das vari√°veis ambientais

env$altitude <- as.factor(env$altitude)
ca.env <- dudi.hillsmith(env, scannf = FALSE)
moran.env <- moran.mc(ca.env$li[, 1], mat_listw, 999)

# Gr√°fico
adegraphics::s.value(xy, ca.env$li[, 1], symbol = "circle",sub = paste("MC =", round(moran.env$statistic, 3)),pSp.col = "grey")

```

Como resultado, √© poss√≠vel que a varia√ß√£o ambiental espacialmente estruturada √© o principal efeito sobre a composi√ß√£o de esp√©cies. Uma maneira de visualizar a contribui√ß√£o relativa de diferentes matrizes (ambiental e espacial, por exemplo) √© utilizar o m√©todo de parti√ß√£o de vari√¢ncia. O resultado deste modelo indica que, de fato, n√£o existe efeito direto das vari√°veis ambientais e sim do componente representado pela autocorrela√ß√£o espacial dessas vari√°veis.

```{r}

### Parti√ß√£o de vari√¢ncia
pv.birds <- varpart(species.hel, env.pad.cat, spatial.pred)
pv.birds
plot(pv.birds)

```

### PERMANOVA

### Explica√ß√£o da an√°lise

A PERMANOVA √© um acr√¥nimo, em ingl√™s, de *permutational multivariate analysis of variance*, an√°lise proposta por Anderson (2001). A PERMANOVA √© usada para testar hip√≥teses multivariadas que comparam a abund√¢ncia de diferentes esp√©cies em resposta a diferentes tratamentos ou gradientes ambientais. Esta an√°lise foi desenvolvida como forma de solucionar algumas limita√ß√µes da tradicional ANOVA multivariada (MANOVA). Em especial, o pressuposto da MANOVA de distribui√ß√£o normal multivariada √© raramente encontrado em dados ecol√≥gicos.

O primeiro passo da PERMANOVA √© selecionar uma medida de dist√¢ncia apropriada aos dados (**cap√≠tulo XXX**) e, al√©m disso, verificar a necessidade de padroniza√ß√£o ou transforma√ß√£o dos dados. Em seguida, as dist√¢ncias s√£o comparadas entre os grupos de interesse (por exemplo, tratamento vs. controle) usando a estat√≠stica *F* de maneira muito parecida com uma ANOVA (**cap√≠tulo XXX**), chamada de *pseudo-F*:

$$
F = (SSa / SSr)*[(N-g) / (g-1)]
$$

onde *SSa* representa a soma dos quadrados entre grupos, *SSr* a soma de quadrados dentro do grupo (residual), *N* o n√∫mero de unidades amostrais e *g* os grupos (ou n√≠veis da vari√°vel categ√≥rica). Esta f√≥rmula do *pseudo-F* √© espec√≠fica para desenho experimental com um fator. Outros desenhos mais complexos s√£o apresetandos em Anderson (2001, 2017). O c√°lculo do valor de probilidade √© realizado por m√©todos de permuta√ß√£o que s√£o discutidos em Anderson & Ter Braak (2003).

## Exemplo 1:

Esp√©cies de aves que ocorrem em localidades com diferentes altitudes.

**Pergunta:**

> O clima e a altitude modificam a composi√ß√£o de esp√©cies de aves?

**Predi√ß√µes**

> Diferen√ßas clim√°ticas (temperatura e chuva) e altitudinais alteram a composi√ß√£o de esp√©cies de aves.

**Vari√°veis**

-   Preditoras: Temperatura e chuva (cont√≠nuas) e altitude (categ√≥rica com tr√™s n√≠veis)

-   Dependente: composi√ß√£o de esp√©cies de aves

```{r message=FALSE, warning=FALSE}

# Composi√ß√£o de esp√©cies padronizar com m√©todo de Hellinger
species.hel <- decostand(species, "hellinger")

# Matriz de dist√¢ncia com m√©todo Bray Curtis
sps.dis <- vegdist(species.hel, "bray")

```

Para reduzir o n√∫mero de vari√°veis no modelo, voc√™ pode considerar duas abordangens. A primeira, e mais importante delas, √© manter somente vari√°veis preditoras que voc√™ tenha raz√£o biol√≥gica para mant√™-la e, al√©m disso, que esteja relacionada com suas hip√≥teses. Assim, uma vez que voc√™ j√° removeu vari√°veis que n√£o tem relev√¢ncia biol√≥gica, voc√™ deve usar diferentes m√©todos (discutidos no Cap√≠tulo XXX) para remover as vari√°veis muito correlacionadas. Neste exemplo, vamos simplesmente fazer uma correla√ß√£o m√∫ltipla e remover as vari√°veis com correla√ß√£o maior do que 0.9 ou -0.9. A fun√ß√£o ggpairs mostra um gr√°fico bem did√°tico para representa a rela√ß√£o entre todas as vari√°veis e o valor (r) desta correla√ß√£o.

```{r message=FALSE, warning=FALSE}

ggpairs(env) 

# Ap√≥s verificar a estrutura de correla√ß√£o, vamos manter somente tr√™s vari√°veis
env2 <- env[,c("mini.jan", "rain.tot", "altitude")]
```

Ap√≥s selecionar as vari√°veis do modelo, vamos executar a PERMANOVA e entender as principais etapas para interpretar corretamente o teste. A fun√ß√£o adonis do pacote vegan √© a melhor op√ß√£o no vegan. Por√©m, √© importante referir o programa PRIMER e PERMANOVA+ como √≥tima op√ß√£o para implementar a PERMANOVA e ter maior controle em desenhos complexos (Anderson et al. 2008). Assim como nos modelos lineares apresentados no cap√≠tulo XXX, os argumento seguem o mesmo formato, com vari√°vel dependente separada por um "\~" das vari√°veis preditoras. Por√©m, alguns autores demonstraram que a PERMANOVA (assim como Mantel e ANOSIM) n√£o pode identificar se diferen√ßas significativas do teste (usando a estat√≠stica *pseudo-F*) se devem a diferen√ßas no posi√ß√£o, na dispers√£o ou ambos. Ou seja, ao comparar grupos n√£o √© poss√≠vel identificar se existe mudan√ßas de composi√ß√£o (posi√ß√£o) ou a varia√ß√£o da composi√ß√£o de esp√©cies dentro de um grupo (dispers√£o) √© maior do que a varia√ß√£o dentro do outro grupo (Anderson & Walsh 2013). Para solucionar este problema, √© poss√≠vel combinar a PERMANOVA com a an√°lise PERMDISP (ou BETADISPER, como chamado no pacote vegan). Esta an√°lise permite comparar se existe heterogeneidade nas vari√¢ncias entre grupos. Deste modo, a presen√ßa de heterogeneidade de vari√¢ncias (valor do BETADISPER significativo), √© poss√≠vel saber que as diferen√ßas entre os grupos ocorre principalmente por diferen√ßas na dispers√£o e n√£o, necessariamente, de posi√ß√£o. Mais detalhes sobre a relev√¢ncia de combinar essas duas an√°lises est√£o dispon√≠veis em Anderson & Walsh (2013).

```{r message=FALSE, warning=FALSE}

perm.aves <- adonis(sps.dis ~ mini.jan + rain.tot + altitude, data = env2)

perm.aves ### Diferen√ßas entre os tratamentos?

betad.aves <-betadisper(sps.dis, env2$altitude)

permutest(betad.aves)
```

Em nosso exemplo, temperatura, chuva e altitude afetaram a varia√ß√£o na composi√ß√£o de esp√©cies. Por√©m, para identificar se as diferen√ßas de composi√ß√£o entre os n√≠veis da vari√°vel altitude, √© necess√°rio interpretar os rsultados da an√°lise BETADISPER. O comando permutest(betad.aves) mostra que o valor de probabilidade da an√°lise foi de 0.253, ou seja, a hip√≥tese nula de que a vari√¢ncia entre grupos √© homog√™nea √© aceita. Assim, n√£o existe diferen√ßas na dispers√£o entre grupo, sugerindo que a diferen√ßa encontrada na PERMANOVA (objeto perm.aves) se deve, em parte, a mudan√ßa na composi√ß√£o de esp√©cies de aves entre diferentes altitudes (R^2^ = 0.135). Al√©m disso, a chuva (R^2^ = 0.183) e temperatura (R^2^ = 0.127) foram fatores importantes na varia√ß√£o da composi√ß√£o de esp√©cies.

Como falado anteriormente, as an√°lises de ordena√ß√£o irrestritas (PCA, PCoA, nMDS) s√£o utilizadas para explorar dados. Uma maneira poderosa de us√°-las √© combinando com an√°lises que testam hip√≥teses, como PERMANOVA e RDA (abaixo). A literatura ecol√≥gica tem usado a an√°lise de escalonamento n√£o m√©trico (nMDS) combinado com an√°lises multidimensionais de vari√¢ncia (como a PERMANOVA) para visualiza√ß√£o da similaridade na composi√ß√£o de esp√©cies dentro e entre grupos. A seguir, implementamos o nMDS na matriz de composi√ß√£o de esp√©cies de √°caros.

```{r message=FALSE, warning=FALSE}

# Matriz de dist√¢ncia representando a varia√ß√£o na composi√ß√£o de esp√©cies (m√©todo Bray-Curtis)

sps.dis # valor calculado anteriormente

# √â preciso calcular uma primeira "melhor" solu√ß√£o do nMDS

sol1 <- metaMDS(sps.dis)

# Depois, executar a mesma fun√ß√£o, mas utilizando uma "melhor solu√ß√£o inicial" para evitar resultdos sub√≥timos no nMDS (veja Legendre & Legendre 2012)

nmds.beta <- metaMDS(sps.dis, previous.best = sol1)

# O stress √© o valor mais importante para interpretar a qualidade da ordena√ß√£o ()
nmds.beta$stress # valor ideal entre 0 e 0.2

# Exportar os valores para fazer gr√°fico 

dat.graf <- data.frame(scores(nmds.beta), altitude = env2$altitude)

# Definir os grupos ("HULL") para serem categorizados no gr√°fico 

grp.mon <- dat.graf[dat.graf$altitude == "Montanhoso", ][chull(dat.graf[dat.graf$altitude == "Montanhoso", c("NMDS1", "NMDS2")]), ]

grp.int <- dat.graf[dat.graf$altitude == "Intermedi√°rio", ][chull(dat.graf[dat.graf$altitude == "Intermedi√°rio", c("NMDS1", "NMDS2")]), ]

grp.pla <- dat.graf[dat.graf$altitude == "Plano", ][chull(dat.graf[dat.graf$altitude == "Plano", c("NMDS1", "NMDS2")]), ]

hull.data <- rbind(grp.mon, grp.int, grp.pla) #combine grp.a and grp.b

hull.data

# Gr√°fico combinado os escores do nMDS com pol√≠gonos dos valores por cada cota altitudinal

dat.graf %>% 
  ggplot(aes(x = NMDS1, 
             y = NMDS2, 
             color = altitude, 
             shape = altitude)) + 
  theme_bw() + 
  geom_point(size=3) + 
  geom_polygon(data = hull.data, 
               aes(fill = altitude, 
                   group = altitude), 
               alpha=0.2) + 
  scale_color_manual(values=c("#4575b4", "#d73027", "#4d4d4d")) +
  scale_fill_manual(values=c("#4575b4", "#d73027", "#4d4d4d")) +
  xlab("NMDS1") + 
  ylab("NMDS2") + 
  theme(axis.title.x = element_text(size=14),
        axis.text.x = element_text(vjust=0.5, 
                                   size=12), 
        axis.title.y = element_text(size=14),
        axis.text.y = element_text(vjust=0.5, 
                                   size=12), 
        legend.position = "top",
        legend.title = element_blank())

```

## 
